{"ast":null,"code":"import _regeneratorRuntime from\"C:/Users/User/Desktop/jbook/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"C:/Users/User/Desktop/jbook/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import axios from'axios';import localForage from'localforage';var fileCache=localForage.createInstance({name:'filecache'});export var fetchPlugin=function fetchPlugin(inputCode){return{name:'fetch-plugin',setup:function setup(build){build.onLoad({filter:/(^index\\.js$)/},function(){return{loader:'jsx',contents:inputCode};});// check for cache results\nbuild.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(args){var cachedResult;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.next=2;return fileCache.getItem(args.path);case 2:cachedResult=_context.sent;if(!cachedResult){_context.next=5;break;}return _context.abrupt(\"return\",cachedResult);case 5:case\"end\":return _context.stop();}}},_callee);}));return function(_x){return _ref.apply(this,arguments);};}());// onload for css\nbuild.onLoad({filter:/.css$/},/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(args){var cachedResult,_yield$axios$get,data,request,escaped,contents,result;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.next=2;return fileCache.getItem(args.path);case 2:cachedResult=_context2.sent;if(!cachedResult){_context2.next=5;break;}return _context2.abrupt(\"return\",cachedResult);case 5:_context2.next=7;return axios.get(args.path);case 7:_yield$axios$get=_context2.sent;data=_yield$axios$get.data;request=_yield$axios$get.request;escaped=data.replace(/\\n/g,'').replace(/\"/g,'\\\\\"').replace(/'/g,\"\\\\'\");contents=\"\\n                    const style = document.createElement('style')\\n                    style.innerText = '\".concat(escaped,\"'\\n                    document.head.appendChild(style)\\n                \");result={loader:'jsx',contents:contents,// find directory of package\nresolveDir:new URL('./',request.responseURL).pathname};// store response in cache\n_context2.next=15;return fileCache.setItem(args.path,result);case 15:return _context2.abrupt(\"return\",result);case 16:case\"end\":return _context2.stop();}}},_callee2);}));return function(_x2){return _ref2.apply(this,arguments);};}());// onload for all other files\nbuild.onLoad({filter:/.*/},/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(args){var _yield$axios$get2,data,request,result;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return axios.get(args.path);case 2:_yield$axios$get2=_context3.sent;data=_yield$axios$get2.data;request=_yield$axios$get2.request;result={loader:'jsx',// modules inputs\ncontents:data,resolveDir:new URL('./',request.responseURL).pathname};_context3.next=8;return fileCache.setItem(args.path,result);case 8:return _context3.abrupt(\"return\",result);case 9:case\"end\":return _context3.stop();}}},_callee3);}));return function(_x3){return _ref3.apply(this,arguments);};}());}};};","map":{"version":3,"sources":["C:/Users/User/Desktop/jbook/src/bundler/plugins/fetch-plugin.ts"],"names":["axios","localForage","fileCache","createInstance","name","fetchPlugin","inputCode","setup","build","onLoad","filter","loader","contents","args","getItem","path","cachedResult","get","data","request","escaped","replace","result","resolveDir","URL","responseURL","pathname","setItem"],"mappings":"iSACA,MAAOA,CAAAA,KAAP,KAAkB,OAAlB,CACA,MAAOC,CAAAA,WAAP,KAAwB,aAAxB,CAEA,GAAMC,CAAAA,SAAS,CAAGD,WAAW,CAACE,cAAZ,CAA2B,CACzCC,IAAI,CAAE,WADmC,CAA3B,CAAlB,CAIA,MAAO,IAAMC,CAAAA,WAAW,CAAG,QAAdA,CAAAA,WAAc,CAACC,SAAD,CAAuB,CAC9C,MAAO,CACHF,IAAI,CAAE,cADH,CAEHG,KAFG,gBAEGC,KAFH,CAE+B,CAC9BA,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,eAAV,CAAb,CAA0C,UAAM,CAC5C,MAAO,CACHC,MAAM,CAAE,KADL,CAEHC,QAAQ,CAAEN,SAFP,CAAP,CAIH,CALD,EAOJ;AACAE,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,IAAV,CAAb,0FAA+B,iBAAOG,IAAP,yJAEAX,CAAAA,SAAS,CAACY,OAAV,CAAwCD,IAAI,CAACE,IAA7C,CAFA,QAErBC,YAFqB,mBAIvBA,YAJuB,yDAKhBA,YALgB,wDAA/B,gEASI;AACAR,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,OAAV,CAAb,2FAAkC,kBAAOG,IAAP,oNACHX,CAAAA,SAAS,CAACY,OAAV,CAAwCD,IAAI,CAACE,IAA7C,CADG,QACxBC,YADwB,oBAG1BA,YAH0B,2DAInBA,YAJmB,gCAMEhB,CAAAA,KAAK,CAACiB,GAAN,CAAUJ,IAAI,CAACE,IAAf,CANF,wCAMtBG,IANsB,kBAMtBA,IANsB,CAMhBC,OANgB,kBAMhBA,OANgB,CAOxBC,OAPwB,CAOdF,IAAI,CACfG,OADW,CACH,KADG,CACI,EADJ,EAEXA,OAFW,CAEH,IAFG,CAEG,KAFH,EAGXA,OAHW,CAGH,IAHG,CAGG,KAHH,CAPc,CAWxBT,QAXwB,uHAaLQ,OAbK,8EAiBxBE,MAjBwB,CAiBO,CACjCX,MAAM,CAAE,KADyB,CAEjCC,QAAQ,CAARA,QAFiC,CAGjC;AACAW,UAAU,CAAE,GAAIC,CAAAA,GAAJ,CAAQ,IAAR,CAAcL,OAAO,CAACM,WAAtB,EAAmCC,QAJd,CAjBP,CAuB9B;AAvB8B,wBAwBxBxB,CAAAA,SAAS,CAACyB,OAAV,CAAkBd,IAAI,CAACE,IAAvB,CAA6BO,MAA7B,CAxBwB,0CA0BvBA,MA1BuB,2DAAlC,kEA6BA;AACAd,KAAK,CAACC,MAAN,CAAa,CAAEC,MAAM,CAAE,IAAV,CAAb,2FAA+B,kBAAOG,IAAP,uLAEKb,CAAAA,KAAK,CAACiB,GAAN,CAAUJ,IAAI,CAACE,IAAf,CAFL,yCAEnBG,IAFmB,mBAEnBA,IAFmB,CAEbC,OAFa,mBAEbA,OAFa,CAIrBG,MAJqB,CAIU,CACjCX,MAAM,CAAE,KADyB,CAEjC;AACAC,QAAQ,CAAEM,IAHuB,CAIjCK,UAAU,CAAE,GAAIC,CAAAA,GAAJ,CAAQ,IAAR,CAAcL,OAAO,CAACM,WAAtB,EAAmCC,QAJd,CAJV,wBAUrBxB,CAAAA,SAAS,CAACyB,OAAV,CAAkBd,IAAI,CAACE,IAAvB,CAA6BO,MAA7B,CAVqB,yCAYpBA,MAZoB,0DAA/B,kEAcH,CAjEE,CAAP,CAmEH,CApEM","sourcesContent":["import * as esbuild from 'esbuild-wasm'\r\nimport axios from 'axios'\r\nimport localForage from 'localforage'\r\n\r\nconst fileCache = localForage.createInstance({\r\n    name: 'filecache'\r\n});\r\n\r\nexport const fetchPlugin = (inputCode: string) => {\r\n    return {\r\n        name: 'fetch-plugin',\r\n        setup(build: esbuild.PluginBuild) {\r\n            build.onLoad({ filter: /(^index\\.js$)/ }, () => {\r\n                return {\r\n                    loader: 'jsx',\r\n                    contents: inputCode,\r\n                }\r\n            })\r\n        \r\n        // check for cache results\r\n        build.onLoad({ filter: /.*/ }, async (args:any) => {\r\n            // check to see if we already fetched this file and if its in the cache\r\n            const cachedResult = await fileCache.getItem<esbuild.OnLoadResult>(args.path) // use type onLoadresult so typescript knows the type\r\n        \r\n            if (cachedResult) {\r\n                return cachedResult\r\n            }\r\n        })\r\n\r\n            // onload for css\r\n            build.onLoad({ filter: /.css$/ }, async (args: any) => {\r\n                const cachedResult = await fileCache.getItem<esbuild.OnLoadResult>(args.path)\r\n        \r\n                if (cachedResult) {\r\n                    return cachedResult;\r\n                }\r\n                const { data, request } = await axios.get(args.path)\r\n                const escaped = data\r\n                    .replace(/\\n/g, '')\r\n                    .replace(/\"/g, '\\\\\"')\r\n                    .replace(/'/g, \"\\\\'\")\r\n                const contents = `\r\n                    const style = document.createElement('style')\r\n                    style.innerText = '${escaped}'\r\n                    document.head.appendChild(style)\r\n                `\r\n        \r\n                const result: esbuild.OnLoadResult = {\r\n                    loader: 'jsx',\r\n                    contents,\r\n                    // find directory of package\r\n                    resolveDir: new URL('./', request.responseURL).pathname,\r\n                }\r\n                // store response in cache\r\n                await fileCache.setItem(args.path, result)\r\n        \r\n                return result\r\n            });\r\n\r\n            // onload for all other files\r\n            build.onLoad({ filter: /.*/ }, async (args: any) => {\r\n                // get data from url for test pkg\r\n                const { data, request } = await axios.get(args.path)\r\n        \r\n                const result: esbuild.OnLoadResult = {\r\n                    loader: 'jsx',\r\n                    // modules inputs\r\n                    contents: data,\r\n                    resolveDir: new URL('./', request.responseURL).pathname\r\n                }\r\n                await fileCache.setItem(args.path, result)\r\n        \r\n                return result\r\n            })\r\n        }\r\n    }\r\n}"]},"metadata":{},"sourceType":"module"}